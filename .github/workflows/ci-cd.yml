name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '18'
  MAVEN_OPTS: '-Dmaven.repo.local=.m2/repository -Xmx1024m -Xms256m'

jobs:
  # å‰ç«¯æ„å»ºå’Œæµ‹è¯•
  frontend-build:
    name: å‰ç«¯æ„å»ºä¸æµ‹è¯•
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./elemeVue
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: './elemeVue/package-lock.json'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»ºé¡¹ç›®
      run: npm run build
      
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: ./elemeVue/dist/
        retention-days: 7

  # åç«¯æ„å»ºå’Œæµ‹è¯•
  backend-build:
    name: åç«¯æ„å»ºä¸æµ‹è¯•
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./elemeSpringBoot
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ç¼–è¯‘é¡¹ç›®
      run: mvn clean compile
      
    - name: è¿è¡Œæµ‹è¯• (æš‚æ—¶è·³è¿‡)
      run: |
        echo "æš‚æ—¶è·³è¿‡æµ‹è¯•ï¼Œä¸“æ³¨äºæ ¸å¿ƒåŠŸèƒ½æ„å»º"
        mvn compile
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/testdb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: testpassword
        
    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: åç«¯æµ‹è¯•æŠ¥å‘Š
        path: './elemeSpringBoot/target/surefire-reports/*.xml'
        reporter: java-junit
        
    - name: æ‰“åŒ…åº”ç”¨
      run: mvn package -DskipTests
      
    - name: ä¸Šä¼ JARåŒ…
      uses: actions/upload-artifact@v4
      with:
        name: backend-jar
        path: ./elemeSpringBoot/target/*.jar
        retention-days: 7

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # SonarCloudéœ€è¦å®Œæ•´çš„gitå†å²
        
    # è¿™é‡Œå¯ä»¥æ·»åŠ SonarCloudæˆ–å…¶ä»–ä»£ç è´¨é‡å·¥å…·
    # - name: SonarCloudæ‰«æ
    #   uses: SonarSource/sonarcloud-github-action@master
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # æ€§èƒ½æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [backend-build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½åç«¯JARåŒ…
      uses: actions/download-artifact@v4
      with:
        name: backend-jar
        path: ./backend-jar/
        
    - name: è®¾ç½® JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    # å¯åŠ¨åº”ç”¨ï¼ˆåå°è¿è¡Œï¼‰
    - name: å¯åŠ¨Spring Bootåº”ç”¨
      run: |
        java -jar ./backend-jar/*.jar &
        sleep 30  # ç­‰å¾…åº”ç”¨å¯åŠ¨
      env:
        SPRING_PROFILES_ACTIVE: test
        
    # è¿è¡ŒJMeteræ€§èƒ½æµ‹è¯•
    - name: è¿è¡ŒJMeteræ€§èƒ½æµ‹è¯•
      run: |
        cd elemeSpringBoot/jmeter-test-plan
        chmod +x *.sh
        ./diagnose-system.sh || true  # ç³»ç»Ÿè¯Šæ–­ï¼Œå¤±è´¥ä¸å½±å“æµç¨‹
        
    - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-reports
        path: ./elemeSpringBoot/jmeter-test-plan/reports/
        retention-days: 30

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡ŒTrivyæ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ä¸Šä¼ Trivyæ‰«æç»“æœåˆ°GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Dockeræ„å»ºï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
  docker-build:
    name: Dockeré•œåƒæ„å»º
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build, code-quality]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: ./frontend-dist/
        
    - name: ä¸‹è½½åç«¯JARåŒ…
      uses: actions/download-artifact@v4
      with:
        name: backend-jar
        path: ./backend-jar/
        
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    # - name: ç™»å½•Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKER_USERNAME }}
    #     password: ${{ secrets.DOCKER_PASSWORD }}
        
    # - name: æ„å»ºå¹¶æ¨é€åç«¯Dockeré•œåƒ
    #   uses: docker/build-push-action@v5
    #   with:
    #     context: .
    #     file: ./elemeSpringBoot/Dockerfile
    #     push: true
    #     tags: |
    #       ${{ secrets.DOCKER_USERNAME }}/eleme-backend:latest
    #       ${{ secrets.DOCKER_USERNAME }}/eleme-backend:${{ github.sha }}
        
    # - name: æ„å»ºå¹¶æ¨é€å‰ç«¯Dockeré•œåƒ
    #   uses: docker/build-push-action@v5
    #   with:
    #     context: ./elemeVue
    #     file: ./elemeVue/Dockerfile
    #     push: true
    #     tags: |
    #       ${{ secrets.DOCKER_USERNAME }}/eleme-frontend:latest
    #       ${{ secrets.DOCKER_USERNAME }}/eleme-frontend:${{ github.sha }}

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    name: éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: github.ref == 'refs/heads/develop'
    environment: development
    
    steps:
    - name: éƒ¨ç½²æç¤º
      run: |
        echo "ğŸš€ å‡†å¤‡éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        echo "å‰ç«¯æ„å»ºå®Œæˆ âœ…"
        echo "åç«¯æ„å»ºå®Œæˆ âœ…"
        # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬
        
  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [docker-build, security-scan, performance-test]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: éƒ¨ç½²æç¤º
      run: |
        echo "ğŸ‰ å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        echo "æ‰€æœ‰æ£€æŸ¥é€šè¿‡ âœ…"
        echo "å®‰å…¨æ‰«æå®Œæˆ âœ…"
        echo "æ€§èƒ½æµ‹è¯•å®Œæˆ âœ…"
        # è¿™é‡Œæ·»åŠ å®é™…çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬

  # é€šçŸ¥
  notification:
    name: æ„å»ºé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: always()
    
    steps:
    - name: å‘é€æ„å»ºçŠ¶æ€é€šçŸ¥
      run: |
        if [[ "${{ needs.frontend-build.result }}" == "success" && "${{ needs.backend-build.result }}" == "success" ]]; then
          echo "âœ… æ„å»ºæˆåŠŸï¼å‰ç«¯å’Œåç«¯éƒ½å·²æˆåŠŸæ„å»ºã€‚"
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ã€‚"
          exit 1
        fi 